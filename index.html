<!DOCTYPE html>
<html lang="en">
<link rel="icon" type="image/png" href="lemon_bowl_transparent.png">
<link rel="apple-touch-icon" href="lemon_bowl_transparent.png">
<script>
    // Show "Add to Home Screen" popup for iOS Safari
    document.addEventListener('DOMContentLoaded', function () {
        function isIos() {
            return /iphone|ipad|ipod/i.test(navigator.userAgent);
        }
        function isSafari() {
            return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        }
        if (isIos() && isSafari() && !window.navigator.standalone) {
            if (!localStorage.getItem('lemmonbowl_ath_popup')) {
                const popup = document.createElement('div');
                popup.style.position = 'fixed';
                popup.style.bottom = '20px';
                popup.style.left = '50%';
                popup.style.transform = 'translateX(-50%)';
                popup.style.background = '#fffbe7';
                popup.style.border = '1px solid #ccc';
                popup.style.borderRadius = '10px';
                popup.style.padding = '16px 20px';
                popup.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
                popup.style.zIndex = '9999';
                popup.style.fontSize = '16px';
                popup.innerHTML = `
                    <span>To save Lemmon Bowl to your Home Screen:<br>
                    Tap <img src="ios.png" alt="Share" style="height:18px;vertical-align:middle;"> then "Add to Home Screen".</span>
                    <button style="margin-left:15px;padding:4px 10px;border-radius:5px;border:1px solid #ccc;background:#f9f9f9;cursor:pointer;">OK</button>
                `;
                document.body.appendChild(popup);
                popup.querySelector('button').onclick = function () {
                    popup.remove();
                    localStorage.setItem('lemmonbowl_ath_popup', '1');
                };
            }
        }
    });
</script>
<script>
    let apiData = null;

    // Helper to get selected season year
    function getSelectedSeasonYear() {
        const seasonDropdown = document.getElementById('season-dropdown');
        return seasonDropdown && seasonDropdown.value ? seasonDropdown.value : seasonDropdown.options[0]?.value || null;
    }

    // Modified Median Score Tracker logic
    async function loadApiData() {
        try {
            const seasonYear = getSelectedSeasonYear();
            const response = await fetch(`${seasonYear}/api_data.json`);
            apiData = await response.json();
            populateWeekDropdown();
        } catch (error) {
            console.error('Error loading API data:', error);
        }
    }

    // Fetch API data from ESPN endpoint for the selected season
    async function fetchApiData() {
        const seasonYear = getSelectedSeasonYear();
        const url = `https://lm-api-reads.fantasy.espn.com/apis/v3/games/ffl/seasons/${seasonYear}/segments/0/leagues/160513?view=modular&view=mNav&view=mMatchupScore&view=mScoreboard&view=mSettings&view=mTopPerformers&view=mTeam`;
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');
            apiData = await response.json();
            populateWeekDropdown();
            alert('API data fetched successfully!');
        } catch (error) {
            console.error('Error fetching API data:', error);
            alert('Failed to fetch API data.');
        }
    }

    // Show/hide fetch button based on season and week selection
    async function updateFetchButtonVisibility() {
        const seasonDropdown = document.getElementById('season-dropdown');
        const weekDropdown = document.getElementById('week-dropdown');
        const fetchBtn = document.getElementById('fetch-api-btn');
        if (!seasonDropdown || !weekDropdown || !fetchBtn) return;

        // Find default season from seasons.json (already loaded in dropdown)
        // Fetch seasons.json and find the default season (where current === true)
        let defaultSeason = null;
        try {
            const response = await fetch('seasons.json');
            const seasonsData = await response.json();
            const currentSeason = seasonsData.seasons.find(season => season.current === true);
            defaultSeason = currentSeason ? currentSeason.id : seasonDropdown.options[0]?.value;
        } catch (error) {
            defaultSeason = seasonDropdown.options[0]?.value;
        }
        const currentWeek = apiData && typeof apiData.scoringPeriodId === 'number'
            ? apiData.scoringPeriodId.toString()
            : weekDropdown.options[0]?.value;

        // Show button only if season is default and week is current
        if (seasonDropdown.value === defaultSeason && weekDropdown.value === currentWeek) {
            fetchBtn.style.display = 'inline-block';
        } else {
            fetchBtn.style.display = 'none';
        }
    }

    // Add fetch button after DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
        const btn = document.createElement('button');
        btn.id = 'fetch-api-btn';
        btn.textContent = 'Fetch Live ESPN Data';
        btn.style.display = 'none';
        btn.onclick = fetchApiData;
        const weekDropdown = document.getElementById('week-dropdown');
        if (weekDropdown) {
            weekDropdown.parentNode.insertBefore(btn, weekDropdown.nextSibling);
        }

        // Update button visibility on dropdown changes
        document.getElementById('season-dropdown').addEventListener('change', () => { updateFetchButtonVisibility(); });
        document.getElementById('week-dropdown').addEventListener('change', () => { updateFetchButtonVisibility(); });

        // Initial visibility
        setTimeout(() => { updateFetchButtonVisibility(); }, 500);
    });

    function populateWeekDropdown() {
        const weekDropdown = document.getElementById('week-dropdown');
        weekDropdown.innerHTML = '';
        // Prepopulate weeks 1-14
        for (let i = 1; i <= 14; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Week ${i}`;
            weekDropdown.appendChild(option);
        }
        // Set default selected week using apiData.scoringPeriodId
        if (apiData && typeof apiData.scoringPeriodId === 'number') {
            weekDropdown.value = apiData.scoringPeriodId;
        }
        updateMedianScoreTable();
    }

    function getTeamName(teamId, apiData) {
        if (!apiData.teams) return teamId;
        const team = apiData.teams.find(t => t.id === teamId);
        return team ? team.name : teamId;
    }

function updateMedianScoreTable() {
    const weekDropdown = document.getElementById('week-dropdown');
    const selectedWeek = parseInt(weekDropdown.value, 10);
    const table = document.getElementById('median-score-table');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    thead.innerHTML = '';
    tbody.innerHTML = '';

    if (!apiData || !apiData.schedule) return;

    // Get all matchups for the selected week
    const weekMatchups = apiData.schedule.filter(w => w.matchupPeriodId === selectedWeek);
    if (!weekMatchups.length) return;

    // Collect all team scores for the week
    let teamScores = [];
    weekMatchups.forEach(matchup => {
        if (matchup.home && matchup.home.teamId != null) {
            const score =
                (matchup.home.totalPoints && matchup.home.totalPoints > 0)
                    ? matchup.home.totalPoints
                    : (matchup.home.pointsByScoringPeriod?.[selectedWeek] || 0);
            const opponentId = matchup.away?.teamId ?? null;
            teamScores.push({ teamId: matchup.home.teamId, opponentId, score });
        }
        if (matchup.away && matchup.away.teamId != null) {
            const score =
                (matchup.away.totalPoints && matchup.away.totalPoints > 0)
                    ? matchup.away.totalPoints
                    : (matchup.away.pointsByScoringPeriod?.[selectedWeek] || 0);
            const opponentId = matchup.home?.teamId ?? null;
            teamScores.push({ teamId: matchup.away.teamId, opponentId, score });
        }
    });

    // If all scores are 0, show only a TBA row
    const allScoresZero = teamScores.every(ts => ts.score === 0);
    if (allScoresZero) {
        const row = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.textContent = 'No scores available yet (TBA)';
        row.appendChild(td);
        tbody.appendChild(row);
        return;
    }

    // Remove duplicates (just in case of double headers)
    const uniqueScores = {};
    teamScores.forEach(ts => {
        if (!uniqueScores[ts.teamId] || ts.score > uniqueScores[ts.teamId].score) {
            uniqueScores[ts.teamId] = ts;
        }
    });
    teamScores = Object.values(uniqueScores);

    // Sort by descending score
    teamScores.sort((a, b) => b.score - a.score);

    // Calculate League Median (average of all team scores)
    const medianScore = (() => {
        const sorted = [...teamScores.map(ts => ts.score)].sort((a, b) => a - b);
        const mid = Math.floor(sorted.length / 2);
        return sorted.length % 2 === 0
            ? (sorted[mid - 1] + sorted[mid]) / 2
            : sorted[mid];
    })();

    // Table headers
    const headerRow = document.createElement('tr');
    ['Team Name', 'Score', 'Week Opponent'].forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);

    // Color helper
    function getRowColor(idx, totalTeams) {
        // Row 1: gold
        if (idx === 0) return '#FFD700';
        // Rows 2â€“6: green
        if (idx >= 1 && idx <= 5) return '#90EE90';
        // League median row handled separately
        // Rows 8â€“12: orange
        if (idx >= 6 && idx <= 10) return '#FFA500';
        // Row 13 (worst): red
        if (idx === 11) return '#FF6347';
        return '';
    }

    const totalTeams = teamScores.length;
    const medianInsertIndex = Math.ceil(totalTeams / 2);

    // Build the table rows
    teamScores.forEach((ts, idx) => {
        // Insert League Median row before lower half
        if (idx === medianInsertIndex) {
            const medianRow = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 3;
            td.textContent = `League Median (${medianScore.toFixed(2)})`;
            td.style.textAlign = 'center';
            td.style.fontWeight = 'bold';
            medianRow.appendChild(td);
            tbody.appendChild(medianRow);
        }

        const row = document.createElement('tr');
        const teamName = getTeamName(ts.teamId, apiData);
        const opponentName = ts.opponentId ? getTeamName(ts.opponentId, apiData) : 'â€”';

        const color = getRowColor(idx, totalTeams);
        const tdTeam = document.createElement('td');
        const tdOpponent = document.createElement('td');
        const tdScore = document.createElement('td');

        tdTeam.textContent = teamName;
        tdOpponent.textContent = opponentName;
        tdScore.textContent = ts.score.toFixed(2);

        if (color) tdScore.style.backgroundColor = color;

        row.appendChild(tdTeam);
        row.appendChild(tdScore);
        row.appendChild(tdOpponent);
        tbody.appendChild(row);
    });
}

    // Load seasons.json to populate the dropdown
    async function loadSeasons() {
        try {
            const response = await fetch('seasons.json');
            const seasonsData = await response.json();

            const seasonDropdown = document.getElementById("season-dropdown");
            seasonDropdown.innerHTML = ""; // Clear previous options to prevent duplicates
            seasonsData.seasons.forEach(season => {
                const option = document.createElement("option");
                option.value = season.id;
                option.textContent = season.id;
                seasonDropdown.appendChild(option);
            });

            // Set the default season as the one marked as "current"
            const currentSeason = seasonsData.seasons.find(season => season.current === true);
            if (currentSeason) {
                seasonDropdown.value = currentSeason.id;
            }

            await updateDataFiles(); // Update data files based on the default or selected season
            await loadApiData(); // Load apiData for median score tracker
        } catch (error) {
            console.error('Error loading seasons data:', error);
        }
    }

    // Update the file names and reload the data when the dropdown changes
    async function updateDataFiles() {
        const selectedYear = document.getElementById("season-dropdown").value;

        const [weeklyData, seasonData, payoutsData] = await Promise.all([
            fetch(`${selectedYear}/weekly.json`).then(res => res.ok ? res.json() : []),
            fetch(`${selectedYear}/season.json`).then(res => res.ok ? res.json() : []),
            fetch(`${selectedYear}/payouts.json`).then(res => res.ok ? res.json() : [])
        ]);

        populateTable('weekly-data', weeklyData);
        populateTable('season-data', seasonData);
        populateTable('payouts-data', payoutsData);
    }

    // Populate a table with JSON data
    function populateTable(tableId, data) {
        const table = document.getElementById(tableId);
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');

        // Clear existing table content
        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (data.length === 0) return;
        // Generate table headers
        const headers = Object.keys(data[0]);
        const headerRow = document.createElement('tr');
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        // Generate table rows
        data.forEach(item => {
            const row = document.createElement('tr');
            headers.forEach(header => {
                const td = document.createElement('td');
                const value = Array.isArray(item[header]) ? item[header].join(', ') : item[header];
                td.textContent = value;
                row.appendChild(td);
            });
            tbody.appendChild(row);
        });
    }

    // Initialize the page and event listeners
    document.addEventListener('DOMContentLoaded', () => {
        loadSeasons();

        const weekDropdown = document.getElementById('week-dropdown');
        if (weekDropdown) {
            weekDropdown.addEventListener('change', updateMedianScoreTable);
        }
        const seasonDropdown = document.getElementById('season-dropdown');
        if (seasonDropdown) {
            seasonDropdown.addEventListener('change', async () => {
                await updateDataFiles();
                await loadApiData();
            });
        }
    });
</script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Lemmon Bowl</title>
    <style type="text/css">
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 320px;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
            word-break: break-word;
        }
        th, td {
            min-width: 30px;
        }
        th:nth-child(2), td:nth-child(2),
        th:nth-child(5), td:nth-child(5) {
            min-width: 0;
            width: 1fr;
        }
        th {
            background: #f9f9f9;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        /* ... rest of your CSS ... */
        th {
            white-space: pre-wrap;
            min-width: 20px;
        }
        th:first-child {
            white-space: nowrap;
        }
        th:nth-child(4) {
            min-width: 30px;
        }
        th:nth-child(7) {
            min-width: 30px;
        }
        .table-container {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 320px;
        }

        th {
            background: #f9f9f9;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        tr:nth-child(odd) {
            background-color: #f1f1f1;
        }

        tr:nth-child(even) {
            background-color: #fff;
        }

        caption {
            font-family: Verdana, sans-serif;
            font-size: 10px;
            line-height: 15px;
            color: #000;
            text-align: left;
        }

        img {
            padding-top: 5px;
            padding-bottom: 5px;
            max-width: 100%;
            height: auto;
        }

        @media screen and (max-width: 800px) {
            th,
            td {
                padding: 8px;
                font-size: 15px;
            }
        }

        @media screen and (max-width: 600px) {
            th,
            td {
                padding: 6px;
                font-size: 14px;
            }
            table {
                font-size: 14px;
            }
        }

        @media screen and (max-width: 400px) {
            th,
            td {
                padding: 4px;
                font-size: 12px;
            }
            table {
                font-size: 12px;
            }
        }
    </style>
</head>

<body>
    <div id="wrapper" style="width:100%; text-align:center">
        <img src="lemon_bowl_logo.png" height="120" width="180" />
    </div><br>

    <!-- Dropdown to select season -->
    <label for="season-dropdown">Select Season: </label>
    <select id="season-dropdown" onchange="updateDataFiles()">
        <!-- Options will be added dynamically -->
    </select><br><br>
    <h2>Median Score Tracker</h2>
    <label for="week-dropdown">Select Week: </label>
    <select id="week-dropdown">
        <!-- Options will be added dynamically -->
    </select>
    <div class="table-container">
        <table id="median-score-table">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>

    <h2>Weekly Top and Bottom Scorers</h2>
    <div class="table-container">
        <table id="weekly-data">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>

    <h2>Playoff Categories</h2>
    <div class="table-container">
        <table id="season-data">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>

    <h2>Total Team Winnings</h2>
    <div class="table-container">
        <table id="payouts-data">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // Load seasons.json to populate the dropdown
        async function loadSeasons() {
            try {
                const response = await fetch('seasons.json');
                const seasonsData = await response.json();

                const seasonDropdown = document.getElementById("season-dropdown");
                seasonDropdown.innerHTML = ""; // Clear previous options to prevent duplicates
                seasonsData.seasons.forEach(season => {
                    const option = document.createElement("option");
                    option.value = season.id;
                    option.textContent = season.id;
                    seasonDropdown.appendChild(option);
                });

                // Set the default season as the one marked as "current"
                const currentSeason = seasonsData.seasons.find(season => season.current === true);
                if (currentSeason) {
                    seasonDropdown.value = currentSeason.id;
                }

                await updateDataFiles(); // Update data files based on the default or selected season
                await loadApiData(); // Load apiData for median score tracker
            } catch (error) {
                console.error('Error loading seasons data:', error);
            }
        }

        // Update the file names and reload the data when the dropdown changes
        async function updateDataFiles() {
            const selectedYear = document.getElementById("season-dropdown").value;

            const [weeklyData, seasonData, payoutsData] = await Promise.all([
                fetch(`${selectedYear}/weekly.json`).then(res => res.ok ? res.json() : []),
                fetch(`${selectedYear}/season.json`).then(res => res.ok ? res.json() : []),
                fetch(`${selectedYear}/payouts.json`).then(res => res.ok ? res.json() : [])
            ]);

            populateTable('weekly-data', weeklyData);
            populateTable('season-data', seasonData);
            populateTable('payouts-data', payoutsData);
        }

        // Populate a table with JSON data
        function populateTable(tableId, data) {
            const table = document.getElementById(tableId);
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');

            // Clear existing table content
            thead.innerHTML = '';
            tbody.innerHTML = '';

            if (data.length === 0) return;
            // Generate table headers
            const headers = Object.keys(data[0]);
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // Generate table rows
            data.forEach(item => {
                const row = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    const value = Array.isArray(item[header]) ? item[header].join(', ') : item[header];
                    td.textContent = value;
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
        }

        // Initialize the page
        loadSeasons();
    </script>
</body>

</html>       
